/**
* Maplace.js 0.1.1
*
* Copyright (c) 2013 Daniele Moraschi
* Licensed under the MIT license
* For all details and documentation:
* http://maplacejs.com
*/
;(function(f,n,e){'use strict';var l,g;l={activateCurrent:function(a){this.html_element.find("select").val(a)},getHtml:function(){var a=this,b="",c;if(1<this.ln){b+='<select class="dropdown controls '+this.o.controls_cssclass+'">';this.ShowOnMenu(this.view_all_key)&&(b+='<option value="'+this.view_all_key+'">'+this.o.view_all_text+"</option>");for(c=0;c<this.ln;c+=1)this.ShowOnMenu(c)&&(b+='<option value="'+(c+1)+'">'+(this.o.locations[c].title||"#"+(c+1))+"</option>");b=f(b+"</select>").bind("change",function(){a.ViewOnMap(this.value)})}(c=
this.o.controls_title)&&(c=f('<div class="controls_title"></div>').css(this.o.controls_applycss?{fontWeight:"bold",fontSize:this.o.controls_on_map?"12px":"inherit",padding:"3px 10px 5px 0"}:{}).append(this.o.controls_title));return this.html_element=f('<div class="wrap_controls"></div>').append(c).append(b)}};g={html_a:function(a,b,c){var e=this;b=b||a+1;c=c||this.o.locations[a].title;a=f('<a data-load="'+b+'" id="ullist_a_'+b+'" href="#'+b+'" title="'+c+'"><span>'+(c||"#"+(a+1))+"</span></a>");a.css(this.o.controls_applycss?
{color:"#666",display:"block",padding:"5px",fontSize:this.o.controls_on_map?"12px":"inherit",textDecoration:"none"}:{});a.on("click",function(a){a.preventDefault();a=f(this).attr("data-load");e.ViewOnMap(a)});return a},activateCurrent:function(a){this.html_element.find("li").removeClass("active");this.html_element.find("#ullist_a_"+a).parent().addClass("active")},getHtml:function(){var a=f("<ul class='ullist controls "+this.o.controls_cssclass+"'></ul>").css(this.o.controls_applycss?{margin:0,padding:0,
listStyleType:"none"}:{}),b;this.ShowOnMenu(this.view_all_key)&&a.append(f("<li></li>").append(g.html_a.call(this,!1,this.view_all_key,this.o.view_all_text)));for(b=0;b<this.ln;b++)this.ShowOnMenu(b)&&a.append(f("<li></li>").append(g.html_a.call(this,b)));(b=this.o.controls_title)&&(b=f('<div class="controls_title"></div>').css(this.o.controls_applycss?{fontWeight:"bold",padding:"3px 10px 5px 0",fontSize:this.o.controls_on_map?"12px":"inherit"}:{}).append(this.o.controls_title));return this.html_element=
f('<div class="wrap_controls"></div>').append(b).append(a)}};var d=function(a){this.VERSION="0.1.1";this.errors=[];this.loaded=!1;this.dev=!1;this.markers=[];this.oMap=!1;this.view_all_key="all";this.infowindow=null;this.ln=0;this.oMap=!1;this.directionsDisplay=this.directionsService=this.Fusion=this.Polygon=this.Polyline=this.current_index=this.current_control=this.controls_wrapper=this.canvas_map=this.map_div=this.oBounds=null;this.o={map_div:"#gmap",controls_div:"#controls",generate_controls:!0,
controls_type:"dropdown",controls_cssclass:"",controls_title:"",controls_on_map:!0,controls_applycss:!0,controls_position:e.maps.ControlPosition.RIGHT_TOP,type:"marker",view_all:!0,view_all_text:"View All",start:0,locations:[],commons:{},map_options:{mapTypeId:e.maps.MapTypeId.ROADMAP,zoom:1},stroke_options:{strokeColor:"#0000FF",strokeOpacity:0.8,strokeWeight:2,fillColor:"#0000FF",fillOpacity:0.4},directions_options:{travelMode:e.maps.TravelMode.DRIVING,unitSystem:e.maps.UnitSystem.METRIC,optimizeWaypoints:!1,
provideRouteAlternatives:!1,avoidHighways:!1,avoidTolls:!1},styles:{},fusion_options:{},directions_panel:null,draggable:!1,show_infowindows:!0,show_markers:!0,infowindow_type:"bubble",beforeViewAll:function(){},afterViewAll:function(){},beforeShow:function(){},afterShow:function(){},afterCreateMarker:function(){},beforeCloseInfowindow:function(){},afterCloseInfowindow:function(){},beforeOpenInfowindow:function(){},afterOpenInfowindow:function(){},afterRoute:function(){},onPolylineClick:function(){}};
this.AddControl("dropdown",l);this.AddControl("list",g);f.extend(!0,this.o,a)};d.prototype.controls={};d.prototype.create_objMap=function(){var a=0,b;for(b in this.o.styles)this.o.styles.hasOwnProperty(b)&&(0===a&&(this.o.map_options.mapTypeControlOptions={mapTypeIds:[e.maps.MapTypeId.ROADMAP]}),a++,this.o.map_options.mapTypeControlOptions.mapTypeIds.push("map_style_"+a));if(this.loaded)this.oMap.setOptions(this.o.map_options);else try{this.map_div.css({position:"relative",overflow:"hidden"}),this.canvas_map=
f("<div>").addClass("canvas_map").css({width:this.map_div.width(),height:this.map_div.height()}).appendTo(this.map_div),this.oMap=new e.maps.Map(this.canvas_map.get(0),this.o.map_options)}catch(c){this.errors.push(c.toString())}a=0;for(b in this.o.styles)this.o.styles.hasOwnProperty(b)&&(a++,this.oMap.mapTypes.set("map_style_"+a,new e.maps.StyledMapType(this.o.styles[b],{name:b})),this.oMap.setMapTypeId("map_style_"+a));this.debug("01")};d.prototype.add_markers_to_objMap=function(){var a;a=this.o.type||
"marker";switch(a){case "marker":for(a=0;a<this.ln;a++)this.create.marker.call(this,a);break;default:this.create[a].apply(this)}};d.prototype.create={marker:function(a){var b=this,c=this.o.locations[a],h,d,j=new e.maps.LatLng(c.lat,c.lon),k=!1===c.visible?!1:!0;f.extend(c,{position:j,map:this.oMap,zIndex:1E4,visible:!1===this.o.show_markers?!1:k});c.image&&(image_w=c.image_w||32,image_h=c.image_h||32,f.extend(c,{icon:new e.maps.MarkerImage(c.image,new e.maps.Size(image_w,image_h),new e.maps.Point(0,
0),new e.maps.Point(image_w/2,image_h/2))}));h=new e.maps.Marker(c);e.maps.event.addListener(h,"click",function(){b.o.beforeShow(a,c,h);d=!1===c.show_infowindows?!1:!0;b.o.show_infowindows&&d&&b.open_infowindow(a,h);b.oMap.panTo(j);c.zoom&&b.oMap.setZoom(c.zoom);b.current_control&&(b.o.generate_controls&&b.current_control.activateCurrent)&&b.current_control.activateCurrent.call(b,a+1);b.current_index=a;b.o.afterShow(a,c,h)});this.oBounds.extend(j);this.markers.push(h);this.o.afterCreateMarker(a,c,
h);c.visible=k;return h},polyline:function(){var a,b,c=[];for(a=0;a<this.ln;a++)b=new e.maps.LatLng(this.o.locations[a].lat,this.o.locations[a].lon),c.push(b),this.create.marker.call(this,a);f.extend(this.o.stroke_options,{path:c,map:this.oMap});this.Polyline?this.Polyline.setOptions(this.o.stroke_options):this.Polyline=new e.maps.Polyline(this.o.stroke_options)},polygon:function(){var a=this,b,c,d=[];for(b=0;b<this.ln;b++)c=new e.maps.LatLng(this.o.locations[b].lat,this.o.locations[b].lon),d.push(c),
this.create.marker.call(this,b);f.extend(this.o.stroke_options,{paths:d,editable:this.o.draggable,map:this.oMap});this.Polygon?this.Polygon.setOptions(this.o.stroke_options):this.Polygon=new e.maps.Polygon(this.o.stroke_options);e.maps.event.addListener(this.Polygon,"click",function(b){a.o.onPolylineClick(b)})},fusion:function(){f.extend(this.o.fusion_options,{styles:[this.o.stroke_options],map:this.oMap});this.Fusion?this.Fusion.setOptions(this.o.fusion_options):this.Fusion=new e.maps.FusionTablesLayer(this.o.fusion_options)},
directions:function(){var a=this,b,c,d,m,j,k=[],g=0;for(b=0;b<this.ln;b++)d=new e.maps.LatLng(this.o.locations[b].lat,this.o.locations[b].lon),0===b?m=d:b===this.ln-1?j=d:(c=!0===this.o.locations[b].stopover?!0:!1,k.push({location:d,stopover:c})),this.create.marker.call(this,b);f.extend(this.o.directions_options,{origin:m,destination:j,waypoints:k});this.directionsService||(this.directionsService=new e.maps.DirectionsService);this.directionsDisplay?this.directionsDisplay.setOptions({draggable:this.o.draggable}):
this.directionsDisplay=new e.maps.DirectionsRenderer({draggable:this.o.draggable});this.directionsDisplay.setMap(this.oMap);this.o.directions_panel&&(this.o.directions_panel=f(this.o.directions_panel),this.directionsDisplay.setPanel(this.o.directions_panel.get(0)));this.o.draggable&&e.maps.event.addListener(this.directionsDisplay,"directions_changed",function(){g=a.compute_distance(a.directionsDisplay.directions);a.o.afterRoute(g)});this.directionsService.route(this.o.directions_options,function(b,
c){c==e.maps.DirectionsStatus.OK&&(g=a.compute_distance(b),a.directionsDisplay.setDirections(b));a.o.afterRoute(g,c,b)})}};d.prototype.compute_distance=function(a){var b=0,c=a.routes[0],d=c.legs.length;for(a=0;a<d;a++)b+=c.legs[a].distance.value;return b};d.prototype.type_to_open={bubble:function(a){this.infowindow=new e.maps.InfoWindow({content:a.html||""})}};d.prototype.open_infowindow=function(a,b){this.CloseInfoWindow();var c=this.o.locations[a],d=c.type||this.o.infowindow_type;c.html&&this.type_to_open[d]&&
(this.o.beforeOpenInfowindow(a,c,b),this.type_to_open[d].call(this,c),this.infowindow.open(this.oMap,b),this.o.afterOpenInfowindow(a,c,b))};d.prototype.get_html_controls=function(){return this.controls[this.o.controls_type]&&this.controls[this.o.controls_type].getHtml?(this.current_control=this.controls[this.o.controls_type],this.current_control.getHtml.apply(this)):""};d.prototype.generate_controls=function(){if(this.o.controls_on_map){var a=f('<div class="on_gmap '+this.o.controls_type+' gmap_controls"></div>').css(this.o.controls_applycss?
{margin:"5px"}:{}),b=f(this.get_html_controls()).css(this.o.controls_applycss?{background:"#fff",padding:"5px",border:"1px solid rgb(113,123,135)",boxShadow:"rgba(0, 0, 0, 0.4) 0px 2px 4px",maxHeight:this.map_div.find(".canvas_map").outerHeight()-80,minWidth:100,overflowY:"auto",overflowX:"hidden"}:{});a.append(b);this.oMap.controls[this.o.controls_position].push(a.get(0))}else this.controls_wrapper.empty(),this.controls_wrapper.append(this.get_html_controls())};d.prototype.init_map=function(){var a=
this,b=0;this.Polyline&&this.Polyline.setMap(null);this.Polygon&&this.Polygon.setMap(null);this.Fusion&&this.Fusion.setMap(null);this.directionsDisplay&&this.directionsDisplay.setMap(null);if(this.markers){for(b in this.markers)if(this.markers[b])try{this.markers[b].setMap(null)}catch(c){a.errors.push(c)}this.markers.length=0;this.markers=[]}this.o.controls_on_map&&this.oMap.controls&&this.oMap.controls[this.o.controls_position].forEach(function(b,c){try{a.oMap.controls[this.o.controls_position].removeAt(c)}catch(d){a.errors.push(d)}});
this.oBounds=new e.maps.LatLngBounds;this.debug("02")};d.prototype.perform_load=function(){1==this.ln?this.ViewOnMap(1):0===this.ln?(this.o.map_options.set_center?this.oMap.setCenter(new e.maps.LatLng(this.o.map_options.set_center[0],this.o.map_options.set_center[1])):this.oMap.fitBounds(this.oBounds),this.oMap.setZoom(this.o.map_options.zoom)):(this.oMap.fitBounds(this.oBounds),"number"==typeof(this.o.start-0)&&0<this.o.start&&this.o.start<=this.ln?this.ViewOnMap(this.o.start):this.ViewOnMap(this.view_all_key))};
d.prototype.debug=function(a){this.dev&&this.errors.length&&console.log(a+": ",this.errors)};d.prototype.AddControl=function(a,b){if(!a||!b)return!1;this.controls[a]=b;return!0};d.prototype.CloseInfoWindow=function(){if(this.infowindow&&(this.current_index||0===this.current_index))this.o.beforeCloseInfowindow(this.current_index,this.o.locations[this.current_index]),this.infowindow.close(),this.infowindow=null,this.o.afterCloseInfowindow(this.current_index,this.o.locations[this.current_index])};d.prototype.ShowOnMenu=
function(a){if(a==this.view_all_key&&this.o.view_all&&1<this.ln)return!0;a=parseInt(a,10);if("number"==typeof(a-0)&&0<=a&&a<this.ln){var b=!1===this.o.locations[a].on_menu?!1:!0;if(!1!==this.o.locations[a].visible&&b)return!0}return!1};d.prototype.ViewOnMap=function(a){if(a==this.view_all_key)this.o.beforeViewAll(),this.current_index=a,0<this.o.locations.length&&(this.o.generate_controls&&this.current_control&&this.current_control.activateCurrent)&&this.current_control.activateCurrent.apply(this,
[a]),this.oMap.fitBounds(this.oBounds),this.CloseInfoWindow(),this.o.afterViewAll();else if(a=parseInt(a,10),"number"==typeof(a-0)&&0<a&&a<=this.ln)try{e.maps.event.trigger(this.markers[a-1],"click")}catch(b){this.errors.push(b.toString())}this.debug("03")};d.prototype.SetLocations=function(a,b){this.o.locations=a;b&&this.Load(!0)};d.prototype.AddLocations=function(a,b){var c=this;f.isArray(a)&&f.each(a,function(a,b){c.o.locations.push(b)});f.isPlainObject(a)&&this.o.locations.push(a);b&&this.Load(!0)};
d.prototype.AddLocation=function(a,b,c){f.isPlainObject(a)&&this.o.locations.splice(b,0,a);c&&this.Load(!0)};d.prototype.RemoveLocations=function(a,b){var c=this,d=0;f.isArray(a)?f.each(a,function(a,b){b-d<c.ln&&c.o.locations.splice(b-d,1);d++}):a<this.ln&&this.o.locations.splice(a,1);b&&this.Load(!0)};d.prototype.Loaded=function(){return this.loaded};d.prototype._init=function(){this.ln=this.o.locations.length;for(var a=0;a<this.ln;a++)f.extend(this.o.locations[a],this.o.commons),this.o.locations[a].html&&
(this.o.locations[a].html=this.o.locations[a].html.replace("%index",a+1),this.o.locations[a].html=this.o.locations[a].html.replace("%title",this.o.locations[a].title||""));this.map_div=f(this.o.map_div);this.controls_wrapper=f(this.o.controls_div)};d.prototype.Load=function(a){f.extend(!0,this.o,a);this._init();this.init_map();this.create_objMap();this.add_markers_to_objMap();1<this.ln&&this.o.generate_controls?this.generate_controls():this.o.generate_controls=!1;var b=this;this.loaded?this.perform_load():
(e.maps.event.addListenerOnce(this.oMap,"idle",function(){b.perform_load()}),e.maps.event.addListener(this.oMap,"resize",function(){b.canvas_map.css({width:b.map_div.width(),height:b.map_div.height()})}));this.loaded=!0};"function"==typeof define&&define.amd?define(function(){return d}):n.Maplace=d})(jQuery,this,google);